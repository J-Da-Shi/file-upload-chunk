<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å¤šæ ¸å¹¶è¡Œæ–‡ä»¶ä¸Šä¼ </title>
</head>
<body>
  <input id="upload" type="file" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.2/spark-md5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.2/axios.min.js"></script>
  <script>
    const upload = document.getElementById('upload');
    upload.addEventListener('change', async function (event) {
      const file = event.target.files[0];
      if (!file) return;

      const CHUNK_SIZE = 1024 * 1024; // 1MB
      const chunks = createChunks(file, CHUNK_SIZE);

      // ä½¿ç”¨ FileReader å°†æ‰€æœ‰åˆ†ç‰‡é¢„è¯»ä¸º ArrayBufferï¼ˆä¾¿äº transferï¼‰
      const buffers = await Promise.all(
        chunks.map(chunk => new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result); // ArrayBuffer
          reader.readAsArrayBuffer(chunk);
        }))
      );

      // åˆ›å»º Worker æ± 
      const numWorkers = Math.min(navigator.hardwareConcurrency || 4, chunks.length);
      const workers = [];
      const hashResults = new Array(chunks.length);
      let completed = 0;
      let nextIndex = 0;

      // ä»»åŠ¡å®Œæˆå›è°ƒ
      const onChunkDone = ({ index, hash }) => {
        hashResults[index] = hash;
        completed++;

        if (completed === chunks.length) {
          const finalHash = SparkMD5.hash(hashResults.join(''));
          console.log('âœ… Final file hash:', finalHash);
          uploadChunks(chunks, finalHash, file.name);

          // ç»ˆæ­¢æ‰€æœ‰ Worker
          workers.forEach(w => w.terminate());
        }
      };

      // åˆ›å»º Worker å¹¶åˆ†é…ä»»åŠ¡
      for (let i = 0; i < numWorkers; i++) {
        const worker = new Worker('worker-buffer.js'); // æ³¨æ„ï¼šæ–° worker æ–‡ä»¶å
        workers.push(worker);

        const assignNext = () => {
          if (nextIndex >= buffers.length) return;
          const index = nextIndex++;
          // transfer ArrayBufferï¼ˆé›¶æ‹·è´ï¼ï¼‰
          worker.postMessage({ index, buffer: buffers[index] }, [buffers[index]]);
        };

        worker.onmessage = (e) => {
          const { success, index, hash, error } = e.data;
          if (!success) {
            console.error(`Chunk ${index} failed:`, error);
            workers.forEach(w => w.terminate());
            return;
          }
          onChunkDone({ index, hash });
          assignNext(); // å¤„ç†å®Œä¸€ä¸ªï¼Œç«‹å³é¢†ä¸‹ä¸€ä¸ª
        };

        assignNext(); // å¯åŠ¨ç¬¬ä¸€ä¸ªä»»åŠ¡
      }
    });

    function createChunks(file, chunkSize) {
      const result = [];
      for (let i = 0; i < file.size; i += chunkSize) {
        result.push(file.slice(i, i + chunkSize));
      }
      return result;
    }

    function uploadChunks(chunks, hash, fileName) {
      const taskArr = [];
      chunks.forEach((chunk, index) => {
        const formData = new FormData();
        formData.append('chunk', chunk);
        formData.append('hash', `${hash}-${index}`);
        formData.append('fileName', fileName);
        taskArr.push(axios.post('http://127.0.0.1:3000/upload', formData));
      });

      Promise.all(taskArr)
        .then(res => console.log('ğŸš€ All chunks uploaded!', res))
        .catch(err => console.error('âŒ Upload failed:', err));
    }
  </script>
</body>
</html>